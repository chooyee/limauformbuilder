const modalBox=document.getElementById("myModal"),modalTitle=document.getElementById("modalLongTitle"),modalBody=document.querySelector(".modal-body"),closeModals=document.querySelectorAll('[data-dismiss="modal"]'),editModalBox=new bootstrap.Modal(modalBox),btnRemove=document.getElementById("btnRemove"),btnCancel=document.getElementById("btnCancel"),btnSave=document.getElementById("btnSave"),btnSaveFormBuilder=document.getElementById("btnSaveFormBuilder"),btnResetFormBuilder=document.getElementById("btnResetFormBuilder"),draggables=[...document.querySelectorAll(".draggable")],dropzones=[...document.querySelectorAll(".dropzone")];var curMirrorElement,curZone,editor=ace.edit("form-json"),formElementJsonConfig=[];function getReference(e,t,n,o){return function(){var t,r,l,d=e.children.length;for(t=0;t<d;t++)if(r=e.children[t],(l=r.getBoundingClientRect()).left+l.width/3>n&&l.top+l.height/3>o)return r;return null}()}function CreateInstance(classNameString,json){var obj=new(eval(classNameString))(json);return obj}function removeJsonElement(e,t){if(Array.isArray(e))for(let n=0;n<e.length;n++){const o=e[n];"Column"===o["element-type"]?o.columns.forEach(e=>{e.components=removeJsonElement(e.components,t)}):o["element-id"]===t&&(e.splice(n,1),n--)}return e}function getFormElementJsonConfig(e){const t=formElementJsonConfig;if(Array.isArray(t)){for(let n=0;n<t.length;n++)if(t[n]["element-id"]===e)return t[n];return null}return null}function refreshEditor(){const e=document.getElementById(formElementJsonConfig[0]["element-id"]),t=formElementJsonConfig[0];t.components=getAllChildElementsRecursive(e),editor.setValue(JSON.stringify(t,null,"\t"))}function getAllChildElementsRecursive(e,t=[]){const n=e.querySelectorAll(`[data-container="${e.id}"][ref="component"]`);for(let e=0;e<n.length;e++){const o=n[e],r=getFormElementJsonConfig(o.id);if("Column"===r["element-type"]){t.push(r);const e=o.id.split("-")[1],n=o.querySelectorAll(`[ref="container"][data-parent="Column-${e}"]`);let l=0;n.forEach(e=>{r.columns[l].components=[],getAllChildElementsRecursive(e,r.columns[l].components),l++})}else t.push(r)}return t}document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector('[ref="container"]'),t={};t["element-id"]=e.id,t["element-group"]="default",t["element-version"]="v1",t["element-type"]="container",t["element-parent"]="",t.components=[],formElementJsonConfig.push(t),editor.session.setMode("ace/mode/json"),editor.session.setUseWrapMode(!0),editor.setHighlightActiveLine(!1),btnSaveFormBuilder.addEventListener("click",e=>{e.preventDefault();const t=editor.getValue();fetch("/api/v1/saveformjson",{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:t}).then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{alert(e.message)}).catch(e=>{console.error("Error:",e),alert("Error: "+e)})}),btnResetFormBuilder.addEventListener("click",t=>{t.preventDefault(),e.innerHTML="",refreshEditor()}),modalBox.addEventListener("hidden.bs.modal",function(e){const t=document.querySelector(".modal-edit-mode");t&&t.classList.remove("modal-edit-mode")}),closeModals.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();const t=document.querySelector(".drag-mirror");if(t){const n=e.target.getAttribute("ref");"sidebar-component"!==t.getAttribute("ref")&&"modal-remove"!=n||t.remove()}const n=document.querySelector(".modal-edit-mode");if(n){"modal-remove"==e.target.getAttribute("ref")&&n.remove()}editModalBox.hide()})}),btnSave.addEventListener("click",e=>{e.preventDefault();let t=document.querySelectorAll(".drag-mirror,div.modal-edit-mode");if(t.length>0){const e=t[0];btnModalSaveEventHandler(e.dataset.type,e)}}),draggables.forEach(e=>{draggableHandler(e)}),dropzones.forEach(e=>{e.addEventListener("dragover",t=>{dropZoneDragoverEventHandler(e,t)}),e.addEventListener("dragenter",e=>{}),e.addEventListener("dragleave",t=>{dropZoneDragleaveEventHandler(e,t)}),e.addEventListener("drop",t=>{elementDropped(e,t)})})}),draggableHandler=(e=>{e.setAttribute("draggable",!0),e.addEventListener("dragstart",t=>{if("sidebar-component"===t.target.getAttribute("ref"))e.classList.add("drag-transit");else{t.target.closest("div.builder-component").classList.add("drag-transit","drag-highlight")}}),e.addEventListener("dragend",t=>{e.classList.remove("drag-transit","drag-highlight"),elementDropped(t)})}),dragComponentEventListeners=(e=>{if("dragComponent"===e.getAttribute("ref")){e.querySelector('[ref="removeComponent"]').addEventListener("click",becRemoveEventHandler),e.querySelector('[ref="editComponent"]').addEventListener("click",becEditEventHandler),draggableHandler(e)}}),becRemoveEventHandler=(e=>{const t=e.target.closest("div.builder-component");t.remove(),formElementJsonConfig=removeJsonElement(formElementJsonConfig,"component-"+t.id),refreshEditor()}),becEditEventHandler=(e=>{const t=e.target.closest("div.builder-component"),n=getFormElementJsonConfig("component-"+t.id);t.classList.add("modal-edit-mode"),t.setAttribute("data-type",n["element-type"]);const o=CreateInstance(n["element-type"],JSON.stringify(n));modalTitle.innerHTML=`${o.group} - ${o.name} - ${o.version}`,modalBody.innerHTML="",modalBody.appendChild(o.renderEditForm()),o.attachEditFormEvent(),editModalBox.show()}),btnModalSaveEventHandler=(async(domElementType,curDomElement)=>{const elementsWithRefInput=modalBox.querySelectorAll('[ref="input"]');let config={};for(const element of elementsWithRefInput){const propName=element.dataset.property;if("checkbox"==element.type&&!element.checked)continue;const propNameBuilder=propName.split("-");if(propNameBuilder.length>1){let currentObj=config;for(let e=0;e<propNameBuilder.length;e++){const t=propNameBuilder[e];currentObj.hasOwnProperty(t)||(currentObj[t]={}),e<propNameBuilder.length-1&&(currentObj=currentObj[t])}eval(`config.${propNameBuilder.join(".")} = '${element.value}'`)}else config[propNameBuilder[0]]=element.value}config.formBuilderMode=!0;const el=CreateInstance(domElementType,JSON.stringify(config));config=el.config,await el.executeButtonSave();const zone=curDomElement.closest('[ref="container"]');zone.insertBefore(el.renderDomElement(),curDomElement),zone.removeChild(curDomElement),config["element-id"]="component-"+el.elementId,config["element-group"]=el.group,config["element-version"]=el.version,config["element-type"]=el.config.type;const newDomEl=document.getElementById(el.elementId);config["element-parent"]=newDomEl.closest('[ref="container"]').id,document.getElementById("component-"+el.elementId).setAttribute("data-container",newDomEl.closest('[ref="container"]').id),formElementJsonConfig.push(config),dragComponentEventListeners(newDomEl),refreshEditor(),editModalBox.hide()}),dropZoneDragoverEventHandler=((e,t)=>{t.preventDefault();let n=document.querySelector(".drag-mirror");if(!n){(n=document.querySelector(".drag-transit").cloneNode(!0)).classList.add("drag-mirror"),n.classList.remove("drag-transit");const t=event.clientY,o=getReference(e,n,event.clientX,t);curMirrorElement=o,e.insertBefore(n,o),curZone=e}}),dropZoneDragleaveEventHandler=((e,t)=>{t.preventDefault();const n=document.querySelector(".drag-mirror");if(n){const t=event.clientY,o=getReference(e,n,event.clientX,t);o!=curMirrorElement&&o!=n&&(curMirrorElement="",n.remove())}}),elementDropped=((e,t)=>{const n=document.querySelector(".drag-mirror");if(hide(document.querySelector(".drag-and-drop-alert")),n){if("sidebar-component"===n.getAttribute("ref")){const e=CreateInstance(n.dataset.type,'{"formBuilderMode":true}');e.Test(),modalTitle.innerHTML=`${e.group} - ${e.name} - ${e.version}`,modalBody.innerHTML="",modalBody.appendChild(e.renderEditForm()),e.attachEditFormEvent(),editModalBox.show()}else{const e=document.querySelector(`#${n.id}:not(.drag-mirror)`),t=n.closest('[ref="container"]');t.insertBefore(e,n),document.getElementById("component-"+e.id).setAttribute("data-container",t.id),n.remove()}refreshEditor()}});var show=function(e){e&&(e.style.display="block")},hide=function(e){e&&(e.style.display="none")};isNullOrEmpty=function(e){return null==e||"string"==typeof e&&""===e.trim()||Array.isArray(e)&&0===e.length};